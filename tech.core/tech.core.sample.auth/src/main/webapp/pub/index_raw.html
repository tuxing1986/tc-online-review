<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>API v3 static web application</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- auth0.com -->
<script src="//cdn.auth0.com/w2/auth0-widget-5.2.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script>
    function callAPI() {
        var endpoint = $("#host").val() + $("#endpoint").val() + $("#resource").val();
        $.ajax({
            url : endpoint,
            dataType : 'json',
            success : function(data) {
                console.log(data);
                $("#ajaxBox").html("<pre>" + syntaxHighlight(data) + "</pre>");
            },
        	error : function(xhr,status,error) {
        	    var context = "status:" + xhr.status + "<br/>context:<br/><pre>" + error + "</pre>";
                $("#ajaxBox").html(context);
        	}
        });
    }

    function syntaxHighlight(json) {
        if (typeof json != 'string') {
            json = JSON.stringify(json, undefined, 2);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(
                        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                        function(match) {
                            var cls = 'number';
                            if (/^"/.test(match)) {
                                if (/:$/.test(match)) {
                                    cls = 'key';
                                } else {
                                    cls = 'string';
                                }
                            } else if (/true|false/.test(match)) {
                                cls = 'boolean';
                            } else if (/null/.test(match)) {
                                cls = 'null';
                            }
                            return '<span class="' + cls + '">' + match + '</span>';
                        });
    }
    
    var userProfile;
    var AUTH0_DOMAIN = 'topcoder-dev.auth0.com';
    function reloadProfile() {
        $("#auth0_domain").text(AUTH0_DOMAIN);
        $("#auth0_token").text(localStorage.getItem('userToken'));
        if(userProfile) {
          $("#auth0_nickname").text(userProfile.nickname);
          $("#auth0_name").text(userProfile.name);
        }
    }
    
    $(document).ready(function() {
        var widget = new Auth0Widget({
            // All this properties are set on auth0-variables.js
            domain: AUTH0_DOMAIN,
            clientID: 'JFDo7HMkf0q2CkVFHojy3zHWafziprhT',
            callbackURL: location.href,
            callbackOnLocationHash: true
        });

        $('.btn-login').click(function(e) {
          e.preventDefault();
          widget.signin({ popup: true} , null, function(err, profile, token) {
            if (err) {
              // Error callback
              console.log("There was an error");
              alert("There was an error logging in");
            } else {
              // Success calback

              // Save the JWT token.
              localStorage.setItem('userToken', token);
              // Save the profile
              userProfile = profile;
              $('.login-box').hide();
              $('.logged-in-box').show();
              $('.nickname').text(profile.nickname);
              $('.nickname').text(profile.name);
              $('.avatar').attr('src', profile.picture);
            }
            reloadProfile();
          });
        });

        $('.btn-logout').click(function(e) {
            localStorage.removeItem('userToken');
            userProfile = null;
            location.reload(true);
        });

        $.ajaxSetup({
            'beforeSend': function(xhr) {
              if (localStorage.getItem('userToken')) {
                xhr.setRequestHeader('Authorization',
                      'Bearer ' + localStorage.getItem('userToken'));
              }
            }
          });
        
        reloadProfile();
    });
</script>
<style type="text/css">
<!--
pre {
  outline: 1px solid #ccc;
  padding: 5px;
  margin: 5px;
}
.string {
  color: green;
}
.number {
  color: darkorange;
}
.boolean {
  color: blue;
}
.null {
  color: magenta;
}
.key {
  color: red;
}
-->
</style>
</head>
<body>
  <h2>API Checker</h2>
  
  <div id="auth0_profile">
  <h3>Auth0 Profile</h3>
    <dl>
      <dt>domain:</dt><dd><div id="auth0_domain"/></dd>
      <dt>auth0 jwt token:</dt><dd><div id="auth0_token"/></dd>
      <dt>login nickname:</dt><dd><div id="auth0_nickname"/></dd>
      <dt>login name:</dt><dd><div id="auth0_name"/></dd>
    </dl>
    <button type="button" class="btn-login" id="btn-login">Login</button>
    <button type="button" class="btn-logout" id="btn-logout">Logout</button>
  </div>
  <h3>API endpoint</h3>
    <dl>
      <dt>host:</dt><dd><input type=text id="host" value="http://core-auth-dev.elasticbeanstalk.com" size=70/></dd>
      <dt>endpoint:</dt><dd><input type=text id="endpoint" value="/api/v2/" disabled="disabled"/></dd>
      <dt>resource:</dt><dd><input type=text id="resource" value="users"/></dd>
    </dl>
    <button type="button" onclick="callAPI()">Call API</button>
  </div>
  <div id="ajaxBox"></div>
</body>
</html>