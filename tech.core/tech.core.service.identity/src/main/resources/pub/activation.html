<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Activation Page</title>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script type="text/javascript" src="./utils.js"></script>
	<script type="text/javascript">
	<!--
    function activate(activationCode, retUrl) {
        var endpoint = "/v3/users/activate?code="+activationCode;
        var patConnectUrl = /https?:\/\/connect\.topcoder(-[0-9a-zA-Z]+)?\.com.*$/;
        if (retUrl && patConnectUrl.test(retUrl)) {
        	endpoint += "&source=connect";
        }        
        var payload = JSON.stringify({param: {}});
        var callback = function() {
            $("#message").html("Redirecting to "+retUrl);
            redirect(retUrl);
        }
        $.ajax({
            url : endpoint,
            type : 'PUT',
            contentType : 'application/json',
            dataType : 'json',
            data: payload,
            success : function(data) {
                console.log(data);
                callback();
            },
        	error : function(xhr,status,error) {
        		console.log(status);
        		console.log(error);
        		var context;
        		if(xhr.responseJSON && xhr.responseJSON.result && xhr.responseJSON.result.content) {
            		console.log(xhr.responseJSON);
        			context = xhr.responseJSON.result.content;
            	} else {
        	    	context = "status: " + xhr.status + " " + error + "<br/>";
            	}
                $("#message").html(context);
                alert(context);
            	callback();
        	}
        });
    }
	
    $(document).ready(function() {
        var params = getQueryParameters();
        var code = params['code'];

		console.log("activation param[code]: "+code);
		
		var redirectURL = params['retUrl'];
		if(!redirectURL || !validateUrl(redirectURL)) {
			redirectURL = 'http://www.topcoder.com';
		}
        if(!code) {
            console.log("Invalid access.");
        	$("#message").html("Invalid access.");
        } else {
        	$("#message").html("Activating user...");
            activate(code, redirectURL);
        }
    });
	-->
	</script>
	<style type="text/css">
	<!--
	#message {
		margin: 20px;
		padding: 10px;
		width: 65%;
	}
	-->
	</style>
</head>
<body>
	<div>
		<span id="message"></span>
	</div>
</body>
</html>
